var areas=[{color:"#0000FF",bounds:{south:30,north:35,west:128.8,east:132}},{color:"#0000FF",bounds:{south:32.5,north:36.5,west:132,east:135.3}},{color:"#0000FF",bounds:{south:33.3,north:34.9,west:135.3,east:138}},{color:"#0000FF",bounds:{south:34.9,north:37.6,west:135.3,east:138}},{color:"#0000FF",bounds:{south:34.5,north:38.5,west:138,east:141.6}},{color:"#0000FF",bounds:{south:38.5,north:41.5,west:139.3,east:142.2}},{color:"#0000FF",bounds:{south:41.5,north:45.6,west:139.3,east:146}}],detailOverlay,detailContainer,detailView,initDetailView=function(){windowSize&&!detailView&&(detailView=$("#detail_view"),(detailContainer=$("#detail_container")).click(function(t){t.stopPropagation()}),(detailOverlay=$("#detail_overlay")).click(function(){hideDetail()}),$("#detail_close").click(function(){return hideDetail(),!1}),new MutationObserver(function(t){setDetailViewHeight()}).observe($("#detail_title")[0],{childList:!0}))},setDetailViewHeight=function(){if(windowSize&&$("#detail_overlay").is(":visible")){var t=$("#detail_container").height(),e=$("#detail_header").outerHeight();$("#detail_view").height(t-e-20)}},hideDetail=function(){location.hash="",detailOverlay.hide()},onClickShowDetail=function(t){var e=decodeURIComponent($(t).data("spoturi"));showDetail(e)},showDetail=function(t){var e=new RequestSpotDetail(t,function(e){if(detailView){location.hash=encodeURIComponent(t);var i=$("<h3 />").text(normalizeLiteral(e.title,"ja"));$("#detail_title").empty().append(i),detailView.empty();var o=function(t){return $("<a />").attr({href:"https://www.google.co.jp/maps/?q="+e.getPosition().text,target:"_blank"}).text(normalizeLiteral(t,"ja"))},n=$("<dl>");if(n.append($("<dt>").text("Resource URI")).append($("<dd>").append($("<a />").attr({href:e.uri,target:"_blank"}).html(separateUri(e.uri)))),e.category&&n.append($("<dt>").text("分類")).append($("<dd>").text(e.category.text)),e.genre&&n.append($("<dt>").text("種別")).append($("<dd>").text(e.genre)),e.place?n.append($("<dt>").text("開催場所")).append($("<dd>").append(o(e.place))):e.address&&n.append($("<dt>").text("住所")).append($("<dd>").append(o(e.address))),e.contact&&n.append($("<dt>").text("連絡先")).append($("<dd>").text(normalizeLiteral(e.contact,"ja"))),e.phone&&n.append($("<dt>").text("電話番号")).append($("<dd>").text(e.phone)),e.price&&n.append($("<dt>").text("料金")).append($("<dd>").text(normalizeLiteral(e.price,"ja"))),e.url&&n.append($("<dt>").text("webサイト")).append($("<dd>").append($("<a />").attr({href:e.url,target:"_blank"}).html(separateUri(e.url)))),e.image&&n.append($("<dt>").text("画像")).append($("<dd>").append($("<img>").attr({src:e.image}))),e.description){var r=normalizeLiteral(e.description,"ja","\n\n");r.length>0&&n.append($("<dt>").text("説明")).append($("<dd>").addClass("description").html(r.replace(/\n/g,"<br>")))}detailView.append(n),detailOverlay.show(),lastOpenInfoWindow&&lastOpenInfoWindow.close(),detailView.scrollTop(0)}});executeSparql(e)},separateUri=function(t){return t.replace(/(\/+)/g,"$1<wbr>")},isGoogleLoading=!1,waitGoogleQueue=[],isGoogleLoaded=function(){return null!=window.google&&null!=google.maps},loadGoogleMaps=function(t,e){if(isGoogleLoaded())t&&t();else if(isGoogleLoading){var i={success:t||function(){},error:e||function(){}};waitGoogleQueue.push(i),setTimeout(function(){waitGoogleQueue.contains(i)&&(i.error(),waitGoogleQueue.remove(i))},2e3)}else{var o=!1;isGoogleLoading=!0,window.google&&(window.google=null),$.getScript("https://maps.googleapis.com/maps/api/js?key="+env.googlemaps_api_key,function(){if(!o)for(o=!0,t&&t();waitGoogleQueue.length>0;)waitGoogleQueue.pop().success();isGoogleLoading=!1}),setTimeout(function(){if(!o){for(o=!0,e&&e();waitGoogleQueue.length>0;)waitGoogleQueue.pop().error();isGoogleLoading=!1}},2e3)}};loadGoogleMaps(function(){console.log("Google Map has loaded.")});var initMenu=function(){$("#content_overlay").click(function(t){$(this).hide(),hideMenu()}),$("#content_container").click(function(t){t.stopPropagation()}),$(".menu a").each(function(t,e){$(e).click(function(t){var e=$(this).data().item;e&&t.preventDefault(),"open"===e?showMenu():"about"===e?(closeMenu(),showContent()):hideMenu()})})},showMenu=function(){$("#content_overlay").show(),$("#content_container").hide(),$(".menu.hidden").show(),$("#menu_link").addClass("open"),$(".menu.head a").addClass("disabled")},hideMenu=function(){hideContent(),closeMenu()},closeMenu=function(){$(".menu.hidden").hide(),$("#menu_link").removeClass("open"),$(".menu.head a").removeClass("disabled")},showContent=function(){$("#content_overlay").show(),$("#content_container").show()},hideContent=function(){$("#content_overlay").hide(),$("#content_container").hide()},windowSize=!1;$(function(){var t,e,i=function(){windowSize={width:window.innerWidth||$(window).width(),height:window.innerHeight||$(window).height()},$("#map_canvas").height(windowSize.height-$("#header").height()),t&&google.maps.event.trigger(t,"resize"),setDetailViewHeight()};i();var o=!1,n=function(){o&&clearTimeout(o),o=setTimeout(i,200)};$(window).resize(n);var r=function(){if(location.hash&&0!==location.hash.length){var t=decodeURIComponent(location.hash.substring(1));showDetail(t)}else hideDetail()};$(window).bind("hashchange",r),initSpinner(),initDetailView(),initMenu(),loadGoogleMaps(function(){var e={center:new google.maps.LatLng(38.5,137),zoom:3,mapTypeControl:!1,navigationControlOptions:{style:google.maps.NavigationControlStyle.SMALL},mapTypeId:google.maps.MapTypeId.ROADMAP},o={south:31,north:45,west:130,east:145};(t=new google.maps.Map(document.getElementById("map_canvas"),e)).fitBounds(o),l(),i()}),r();var a,s=[],l=function(){for(var e=0;e<areas.length;e++){var i=areas[e],o=new google.maps.Rectangle({strokeColor:i.color,strokeOpacity:.8,strokeWeight:2,fillColor:i.color,fillOpacity:.4,map:t,bounds:i.bounds});s.push(o),google.maps.event.addListener(o,"click",function(e){var i=p(this);d(i),h(),this.setVisible(!1),t.fitBounds(i)})}},p=function(t){var e=t.getBounds(),i=e.getNorthEast(),o=e.getSouthWest();return{south:o.lat(),north:i.lat(),west:o.lng(),east:i.lng()}},h=function(){for(var t=0;t<s.length;t++)s[t].setVisible(!0)},d=function(t){a&&(a.clearMarkers(),u={}),$("form#ui").empty(),showSpinner();var i=new RequestSpot(t,function(t){e=t,f()});executeSparql(i)},u={},c=function(t){return u.hasOwnProperty(t)||(u[t]=[]),u[t]},g=function(){a.clearMarkers();for(var t in u)$(".filter[value='"+t+"']").prop("checked")&&a.addMarkers(c(t))},f=function(){console.log("spots count",Object.keys(e).length),$.each(e,function(e,i){c(i.category.key).push(i.getMarker(t))}),a=new MarkerClusterer(t,[],{imagePath:"images/clusterer-m",maxZoom:17});var i=$("form#ui");i.empty();for(var o in u){var r={id:o,type:"checkbox",name:"filter",value:o},s=$("<input>").addClass("filter").attr(r).prop("checked",!0).change(g);i.append(s).append($("<label>").attr("for",o).text(categories[o].text)),a.addMarkers(c(o))}n(),stopSpinner()}});var getPinIcon=function(t){return{url:"images/pin-"+t+".png",scaledSize:new google.maps.Size(50,60)}},GeoPosition=function(t,e){this.latitude=t,this.longitude=e,this.text=new Number(t).toFixed(6)+","+new Number(e).toFixed(6)};GeoPosition.prototype.toGeo3x3=function(t){for(var e=(90-this.latitude)/180,i=(this.longitude<0?this.longitude+180:this.longitude)/180,o=this.longitude<0?"W":"E",n=1;n<t;n++){i*=3,e*=3;var r=Math.floor(i),a=Math.floor(e);o+=r+3*a+1,i-=r,e-=a}return new Geo3x3(o)},GeoPosition.prototype.getLatLng=function(){return google.maps.LatLng?new google.maps.LatLng(this.latitude,this.longitude):{lat:this.latitude,lng:this.longitude}};var Geo3x3=function(t){if(t&&0!==t.length){for(var e="W"===t.charAt(0),i=0,o=0,n=1,r=1,a=1;a<t.length;a++){var s="0123456789".indexOf(t.charAt(a));if(s<0)return;if(0===s)break;r*=3,n++,--s>0&&(i+=s%3/r,o+=Math.floor(s/3)/r)}this.unit=180/r,r*=2,this.code=t,this.lat=90-180*(o+1/r),this.lng=180*(i+1/r)-(e?180:0),this.level=n}};Geo3x3.prototype.getAncestor=function(t){var e=t;return e>this.level&&(e=this.level),new Geo3x3(this.code.substring(0,e))};var defaultParseBindings=function(t,e){for(var i=[],o=t.head.vars,n=t.results.bindings,r=0;r<n.length;r++){for(var a={lang:{}},s=0;s<o.length;s++){var l=o[s],p=n[r][l];a[l]=parseTypedLiteral(p,e)}i.push(a)}return i},parseTypedLiteral=function(t,e){if(!t)return null;if(!1 in t);else{if("uri"===t.type)return t.value;if("typed-literal"!==t.type);else{if("http://www.w3.org/2001/XMLSchema#integer"===t.datatype)return parseInt(t.value);if("http://www.w3.org/2001/XMLSchema#float"===t.datatype)return parseFloat(t.value);if("http://www.w3.org/2001/XMLSchema#gYear"===t.datatype)return parseInt(t.value);if("http://www.w3.org/2001/XMLSchema#dateTime"===t.datatype)return newDate(t.value)}}return e?e(t):t.value},parser=function(t){return function(e){var i=t.parseBindings||defaultParseBindings;t.parse(i(e,t.parseLiteral))}},executeSparql=function(t){var e=t.query();e&&$.ajax({type:"GET",url:t.endpoint||getEnv().sparql_endpoint,dataType:"jsonp",accepts:{json:"application/javascript"},jsonpCallback:"receive"+t.name,data:{query:e,output:"json",app_name:getEnv().app_name},success:parser(t)})},Prefix=function(t,e){this.name=t,this.uri=e};Prefix.prototype.match=function(t){return t.startsWith(this.uri)},Prefix.prototype.toShortForm=function(t){return this.name+":"+t.substring(this.uri.length)};var prefixArray=[new Prefix("ic","http://imi.go.jp/ns/core/rdf#"),new Prefix("odp","http://odp.jig.jp/odp/1.0#"),new Prefix("rdfs","http://www.w3.org/2000/01/rdf-schema#"),new Prefix("rdf","http://www.w3.org/1999/02/22-rdf-syntax-ns#"),new Prefix("schema","http://schema.org/"),new Prefix("dct","http://purl.org/dc/terms/"),new Prefix("geo","http://www.w3.org/2003/01/geo/wgs84_pos#"),new Prefix("dsv","http://datashelf.jp/ns/dsv#"),new Prefix("kobe","http://data.city.kobe.lg.jp/ns/kobetoday#")],toShortForm=function(t){for(var e=0;e<prefixArray.length;e++){var i=prefixArray[e];if(i.match(t))return i.toShortForm(t)}return"<"+t+">"},initSpinner=function(){$("#spinner_overlay").click(function(t){t.stopPropagation()})},showSpinner=function(){$("#spinner_overlay").fadeIn()},stopSpinner=function(){$("#spinner_overlay").fadeOut()},SpotCategory=function(t,e){this.key=t,this.text=e},Spot=function(t){this.uri=t.uri,this.position=new GeoPosition(parseFloat(t.lat),parseFloat(t.lng)),this.type=t.type2||t.type1,this.genre=t.genre1,this.category=getCategory(this.type,this.genre)},lastOpenInfoWindow;Spot.prototype.getMarker=function(t){if(this.marker?this.marker.setTitle(this.title):this.marker=new google.maps.Marker({position:this.position.getLatLng(),title:this.title,icon:getPinIcon(this.category.key)}),t){var e=new google.maps.InfoWindow({content:this.getInfoContent(),maxWidth:300});e.setPosition(this.position.getLatLng()),this.markerClickListener&&marker.removeListener(this.markerClickListener),this.markerClickListener=this.marker.addListener("click",function(){lastOpenInfoWindow&&lastOpenInfoWindow.close(),e!==lastOpenInfoWindow?(e.open(t,this),lastOpenInfoWindow=e):lastOpenInfoWindow=void 0})}return this.marker},Spot.prototype.getInfoContent=function(){var t='<div id="info"><dl>';return this.title&&(t+="<dt>タイトル</dt><dd>"+this.title+"</dd>"),t+="<dt>分類</dt><dd>"+this.category.text+"</dd>",this.genre&&(t+="<dt>種別</dt><dd>"+this.genre+"</dd>"),t+"<dt>地理座標</dt><dd>"+this.position.text+'</dd></dl><div style="text-align:right;"><a href="#'+encodeURIComponent(this.uri)+'">詳細はこちら</a></div></div>'};var categories={event:new SpotCategory("event","イベント"),hazard:new SpotCategory("hazard","防災"),tourspot:new SpotCategory("tourspot","観光"),facility:new SpotCategory("facility","施設"),other:new SpotCategory("other","その他")},typeMap={"http://purl.org/jrrk#CivicEvent":"event","http://purl.org/jrrk#CivicPOI":"tourspot","http://purl.org/jrrk#CulturalProperty":"tourspot","http://purl.org/jrrk#EmergencyFacility":"hazard","http://purl.org/jrrk#TemporaryGatheringLocation":"hazard","http://purl.org/jrrk#RequiringAssistanceAuthorizedUsersFacilityDisaster":"hazard","http://purl.org/jrrk#CivicFacility":"facility","http://purl.org/jrrk#MedicalInstitute":"facility","http://purl.org/jrrk#ParkingFacility":"facility","http://purl.org/jrrk#Polls":"facility","http://purl.org/jrrk#PosterPlace":"facility","http://purl.org/jrrk#BusStop":"facility","http://purl.org/jrrk#FarmersMarket":"facility","http://odp.jig.jp/odp/1.0#TourSpot":"tourspot","http://odp.jig.jp/odp/1.0#Polls":"facility","http://odp.jig.jp/odp/1.0#PosterPlace":"facility","http://imi.go.jp/ns/core/rdf#施設型":"facility","http://imi.go.jp/ns/core/rdf#イベント型":"event","http://datashelf.jp/ns/dsv#観光スポット型":"tourspot","http://datashelf.jp/ns/dsv#観光スポット":"tourspot","http://datashelf.jp/ns/dsv#応急給水拠点":"hazard",last:!1},getCategory=function(t){var e=typeMap[t];return e||unknownType[t]||(unknownType[t]=!0),categories[e]},unknownType={},RequestSpot=function(t,e){this.name="Spot",this.offset=0,this.limit=1e4,this.executed=!1,this.spots={},this.bounds=t,this.callback=e||function(){console.log("spot data has loaded.")}};RequestSpot.prototype.query=function(){return"PREFIX ic: <http://imi.go.jp/ns/core/rdf#> PREFIX odp: <http://odp.jig.jp/odp/1.0#> PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#> PREFIX xsd: <http://www.w3.org/2001/XMLSchema#> SELECT ?s1 ?type1 ?s2 ?type2 ?genre1 ?lat ?lng { ?s1 ic:地理座標 [ ic:緯度 ?lat ; ic:経度 ?lng ] ; a ?type1 . OPTIONAL { { ?s1 ic:種別 ?genre1 } UNION { ?s1 odp:genre/rdf:_1/odp:genre* [ a odp:LargeGenre ; rdfs:label ?genre1 ] } } . OPTIONAL { ?s2 ?p1 ?s1 ; a ?type2 } . FILTER ( (!BOUND(?p1) || ?p1 != <http://www.w3.org/2002/07/owl#sameAs>)  && xsd:float(?lat)>"+this.bounds.south.toFixed(2)+" && xsd:float(?lat)<"+this.bounds.north.toFixed(2)+" && xsd:float(?lng)>"+this.bounds.west.toFixed(2)+" && xsd:float(?lng)<"+this.bounds.east.toFixed(2)+") } ORDER BY ?s1 ?s2 OFFSET "+this.offset+" LIMIT "+this.limit},RequestSpot.prototype.parse=function(t){for(var e=0;e<t.length;e++){var i=t[e];i.uri=i.s2||i.s1;var o=new Spot(i);this.spots.hasOwnProperty(o.uri)||(this.spots[o.uri]=o)}if(t.length===this.limit)this.offset+=this.limit,executeSparql(this);else{var n=this,r=new RequestSpotTitle(this.spots,this.bounds,function(){n.callback(n.spots)});executeSparql(r)}};var RequestSpotTitle=function(t,e,i){this.name="SpotTitle",this.offset=0,this.limit=1e4,this.spots=t,this.executed=!1,this.bounds=e,this.uris=this.getSpotUris(),this.filter=this.nextFilter(),this.last=null,this.callback=i||function(){console.log("spot title has loaded.")}};RequestSpotTitle.prototype.getSpotUris=function(){var t=[];for(var e in this.spots)t.push(e);return t.sort()},RequestSpotTitle.prototype.nextFilter=function(){var t,e=this.last,i=this.uris;if(e){var o;for(o=0;o<i.length&&!(e<i[o]);o++);o+=this.limit,t=i[i.length<=o?i.length-1:o]}else e=i[0],t=i[i.length<=this.limit?i.length-1:this.limit];return' && str(?s)>"'+e+'" && str(?s)<="'+t+'" '},RequestSpotTitle.prototype.query=function(){return'PREFIX ic: <http://imi.go.jp/ns/core/rdf#> PREFIX odp: <http://odp.jig.jp/odp/1.0#> PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#> PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> PREFIX xsd: <http://www.w3.org/2001/XMLSchema#> SELECT ?s ?title { ?s ic:名称/ic:表記 ?title. FILTER (!isBlank(?s) && lang(?title) in ("ja", "")'+this.filter+") } ORDER BY ?s OFFSET "+this.offset+" LIMIT "+this.limit},RequestSpotTitle.prototype.parse=function(t){for(var e=this.last,i=0;i<t.length;i++){var o=t[i],n=this.spots[o.s];n&&(n.title=o.title),(!this.last||this.last<o.s)&&(this.last=o.s)}t.length===this.limit?(e===this.last?this.offset+=this.limit:(this.offset=0,this.filter=this.nextFilter()),executeSparql(this)):this.last<this.uris.last()?(this.offset=0,this.filter=this.nextFilter(),executeSparql(this)):this.callback()};var RequestSpotDetail=function(t,e){this.name="SpotDetail",this.offset=0,this.limit=1e4,this.uri=t,this.executed=!1,this.callback=e||function(t){console.log("spot detail has loaded.",t)},this.result={}};RequestSpotDetail.prototype.query=function(){return"PREFIX ic: <http://imi.go.jp/ns/core/rdf#> PREFIX odp: <http://odp.jig.jp/odp/1.0#> PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#> PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> SELECT ?p1 ?o1 ?p2 ?o2 ?p3 ?o3 { <"+this.uri+"> ?p1 ?o1 . OPTIONAL { ?o1 ?p2 ?o2 . OPTIONAL { ?o2 ?p3 ?o3 } } } ORDER BY ?p1 ?o1 ?p2 ?o2 ?p3 ?o3 OFFSET "+this.offset+" LIMIT "+this.limit},RequestSpotDetail.prototype.parse=function(t){for(var e=0;e<t.length;e++){var i=this.getPropertyAndObject(t[e]);if(this.result[i.property])if($.isArray(this.result[i.property]))this.result[i.property].push(i.object);else{var o=[];o.push(this.result[i.property]),o.push(i.object),this.result[i.property]=o}else this.result[i.property]=i.object}t.length===this.limit?(this.offset+=this.limit,executeSparql(this)):this.callback(new SpotDetail(this.uri,this.result))},RequestSpotDetail.prototype.parseLiteral=function(t){var e=t["xml:lang"];return e&&e.length>0?{value:t.value,lang:e}:t.value},RequestSpotDetail.prototype.getPropertyAndObject=function(t){for(var e=toShortForm(t.p1),i=t.o1,o=2;o<=3;o++){var n="p"+o;if(!t[n])break;e+="/"+toShortForm(t[n]),i=t["o"+o]}return{property:e,object:i}};var SpotDetail=function(t,e){this.data=e,this.uri=t,this.title=e["ic:名称/ic:表記"]||e["rdfs:label"],this.category=getCategory(e["rdf:type"]),this.description=e["ic:説明"]||e["schema:description"],this.note=e["kobe:ScheduleNotice"];var i=e["ic:Webサイト"]||e["schema:url"];i&&!i.startsWith("http")&&(i=null),this.url=i,this.address=e["ic:住所/ic:表記"]||e["ic:開催場所/ic:住所/ic:表記"],this.place=e["ic:開催場所/ic:名称/ic:表記"],this.price=e["ic:料金/ic:表記"],this.genre=normalizeLiteral(e["ic:種別"],"ja"," / "),this.image=e["ic:画像"]||e["schema:image"],this.contact=e["ic:連絡先/ic:名称/ic:表記"];var o=e["ic:連絡先/ic:電話番号"];o&&o.length>6&&(this.phone=o),this.latitude=e["ic:地理座標/ic:緯度"]||e["ic:開催場所/ic:地理座標/ic:緯度"]||e["geo:lat"],this.longitude=e["ic:地理座標/ic:経度"]||e["ic:開催場所/ic:地理座標/ic:経度"]||e["geo:long"]};SpotDetail.prototype.getPosition=function(){return this.latitude&&this.longitude?new GeoPosition(this.latitude,this.longitude):null},SpotDetail.prototype.getCategory=function(){return this.type?getCategory(this.type):null};var normalizeLiteral=function(t,e,i){if(t){if($.isArray(t)){for(var o=[],n=0;n<t.length;n++){var r=t[n];r.lang?r.lang===e&&o.push(r.value):o.push(r)}return i=i||" / ",o.join(i)}if(t.lang)return t.lang===e?t.value:""}else;return t};Array.prototype.contains=function(t){for(var e=0;e<this.length;e++)if(this[e]===t)return!0;return!1},Array.prototype.last=function(){return 0===this.length?null:this[this.length-1]};var join=function(t,e){return $.isArray(t)?t.join(e):t};