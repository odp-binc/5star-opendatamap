var detailOverlay,detailContainer,detailView,initDetailView=function(){windowSize&&!detailView&&(detailView=$("#detail_view"),(detailContainer=$("#detail_container")).click(function(t){t.stopPropagation()}),(detailOverlay=$("#detail_overlay")).click(function(){detailOverlay.hide()}),$("#detail_close").click(function(){return detailOverlay.hide(),!1}),new MutationObserver(function(t){setDetailViewHeight()}).observe($("#detail_title")[0],{childList:!0}))},setDetailViewHeight=function(){if(windowSize&&$("#detail_overlay").is(":visible")){var t=$("#detail_container").height(),e=$("#detail_header").outerHeight();$("#detail_view").height(t-e-20)}},showDetail=function(t){var e=decodeURIComponent($(t).data("spoturi")),i=new RequestSpotDetail(e,function(t){if(detailView){var e=$("<h3 />").text(normalizeLiteral(t.title,"ja"));$("#detail_title").empty().append(e),detailView.empty();var i=function(e){return $("<a />").attr({href:"https://www.google.co.jp/maps/?q="+t.getPosition().text,target:"_blank"}).text(normalizeLiteral(e,"ja"))},o=$("<dl>");if(t.category&&o.append($("<dt>").text("分類")).append($("<dd>").text(t.category.text)),t.genre&&o.append($("<dt>").text("種別")).append($("<dd>").text(t.genre)),t.place?o.append($("<dt>").text("開催場所")).append($("<dd>").append(i(t.place))):t.address&&o.append($("<dt>").text("住所")).append($("<dd>").append(i(t.address))),t.contact&&o.append($("<dt>").text("連絡先")).append($("<dd>").text(normalizeLiteral(t.contact,"ja"))),t.phone&&o.append($("<dt>").text("電話番号")).append($("<dd>").text(t.phone)),t.price&&o.append($("<dt>").text("料金")).append($("<dd>").text(normalizeLiteral(t.price,"ja"))),t.url&&o.append($("<dt>").text("webサイト")).append($("<dd>").append($("<a />").attr({href:t.url,target:"_blank"}).html(t.url.replace(/(\/+)/g,"$1<wbr>")))),t.image&&o.append($("<dt>").text("画像")).append($("<dd>").append($("<img>").attr({src:t.image}))),t.description){var r=normalizeLiteral(t.description,"ja","\n\n");r.length>0&&o.append($("<dt>").text("説明")).append($("<dd>").addClass("description").html(r.replace(/\n/g,"<br>")))}detailView.append(o),detailOverlay.show(),lastOpenInfoWindow.close()}});executeSparql(i)},isGoogleLoading=!1,waitGoogleQueue=[],isGoogleLoaded=function(){return null!=window.google&&null!=google.maps},loadGoogleMaps=function(t,e){if(isGoogleLoaded())t&&t();else if(isGoogleLoading){var i={success:t||function(){},error:e||function(){}};waitGoogleQueue.push(i),setTimeout(function(){waitGoogleQueue.contains(i)&&(i.error(),waitGoogleQueue.remove(i))},2e3)}else{var o=!1;isGoogleLoading=!0,window.google&&(window.google=null),$.getScript("https://maps.googleapis.com/maps/api/js?key="+env.googlemaps_api_key,function(){if(!o)for(o=!0,t&&t();waitGoogleQueue.length>0;)waitGoogleQueue.pop().success();isGoogleLoading=!1}),setTimeout(function(){if(!o){for(o=!0,e&&e();waitGoogleQueue.length>0;)waitGoogleQueue.pop().error();isGoogleLoading=!1}},2e3)}};loadGoogleMaps(function(){console.log("Google Map has loaded.")});var initMenu=function(){$("#content_overlay").click(function(t){$(this).hide(),hideMenu()}),$("#content_container").click(function(t){t.stopPropagation()}),$(".menu a").each(function(t,e){$(e).click(function(t){var e=$(this).data().item;e&&t.preventDefault(),"open"===e?showMenu():"about"===e?(closeMenu(),showContent()):hideMenu()})})},showMenu=function(){$("#content_overlay").show(),$("#content_container").hide(),$(".menu.hidden").show(),$("#menu_link").addClass("open"),$(".menu.head a").addClass("disabled")},hideMenu=function(){hideContent(),closeMenu()},closeMenu=function(){$(".menu.hidden").hide(),$("#menu_link").removeClass("open"),$(".menu.head a").removeClass("disabled")},showContent=function(){$("#content_overlay").show(),$("#content_container").show()},hideContent=function(){$("#content_overlay").hide(),$("#content_container").hide()},windowSize=!1;$(function(){var t,e,i=function(){windowSize={width:window.innerWidth||$(window).width(),height:window.innerHeight||$(window).height()},$("#map_canvas").height(windowSize.height-$("#header").height()),t&&google.maps.event.trigger(t,"resize"),setDetailViewHeight()};i();var o=!1,r=function(){o&&clearTimeout(o),o=setTimeout(i,200)};$(window).resize(r),initSpinner(),initDetailView(),initMenu(),loadGoogleMaps(function(){var i={center:new google.maps.LatLng(38.5,137),zoom:3,mapTypeControl:!1,navigationControlOptions:{style:google.maps.NavigationControlStyle.SMALL},mapTypeId:google.maps.MapTypeId.ROADMAP};(t=new google.maps.Map(document.getElementById("map_canvas"),i)).fitBounds({south:34.5,north:42.5,west:131,east:144});var o=new RequestSpot(function(t){e=t,l()});executeSparql(o)});var n,a={},s=function(t){return a.hasOwnProperty(t)||(a[t]=[]),a[t]},p=function(){n.clearMarkers();for(var t in a)$(".filter[value='"+t+"']").prop("checked")&&n.addMarkers(s(t))},l=function(){$.each(e,function(e,i){s(i.category.key).push(i.getMarker(t))}),n=new MarkerClusterer(t,[],{imagePath:"images/clusterer-m",maxZoom:17});var i=$("form#ui");for(var o in a){var l={id:o,type:"checkbox",name:"filter",value:o},d=$("<input>").addClass("filter").attr(l).prop("checked",!0).change(p);i.append(d).append($("<label>").attr("for",o).text(categories[o].text)),n.addMarkers(s(o))}r(),stopSpinner()}});var getPinIcon=function(t){return{url:"images/pin-"+t+".png",scaledSize:new google.maps.Size(50,60)}},GeoPosition=function(t,e){this.latitude=t,this.longitude=e,this.text=new Number(t).toFixed(6)+","+new Number(e).toFixed(6)};GeoPosition.prototype.toGeo3x3=function(t){for(var e=(90-this.latitude)/180,i=(this.longitude<0?this.longitude+180:this.longitude)/180,o=this.longitude<0?"W":"E",r=1;r<t;r++){i*=3,e*=3;var n=Math.floor(i),a=Math.floor(e);o+=n+3*a+1,i-=n,e-=a}return new Geo3x3(o)},GeoPosition.prototype.getLatLng=function(){return google.maps.LatLng?new google.maps.LatLng(this.latitude,this.longitude):{lat:this.latitude,lng:this.longitude}};var Geo3x3=function(t){if(t&&0!==t.length){for(var e="W"===t.charAt(0),i=0,o=0,r=1,n=1,a=1;a<t.length;a++){var s="0123456789".indexOf(t.charAt(a));if(s<0)return;if(0===s)break;n*=3,r++,--s>0&&(i+=s%3/n,o+=Math.floor(s/3)/n)}this.unit=180/n,n*=2,this.code=t,this.lat=90-180*(o+1/n),this.lng=180*(i+1/n)-(e?180:0),this.level=r}};Geo3x3.prototype.getAncestor=function(t){var e=t;return e>this.level&&(e=this.level),new Geo3x3(this.code.substring(0,e))};var defaultParseBindings=function(t,e){for(var i=[],o=t.head.vars,r=t.results.bindings,n=0;n<r.length;n++){for(var a={lang:{}},s=0;s<o.length;s++){var p=o[s],l=r[n][p];a[p]=parseTypedLiteral(l,e)}i.push(a)}return i},parseTypedLiteral=function(t,e){if(!t)return null;if(!1 in t);else{if("uri"===t.type)return t.value;if("typed-literal"!==t.type);else{if("http://www.w3.org/2001/XMLSchema#integer"===t.datatype)return parseInt(t.value);if("http://www.w3.org/2001/XMLSchema#float"===t.datatype)return parseFloat(t.value);if("http://www.w3.org/2001/XMLSchema#gYear"===t.datatype)return parseInt(t.value);if("http://www.w3.org/2001/XMLSchema#dateTime"===t.datatype)return newDate(t.value)}}return e?e(t):t.value},parser=function(t){return function(e){var i=t.parseBindings||defaultParseBindings;t.parse(i(e,t.parseLiteral))}},executeSparql=function(t){var e=t.query();e&&$.ajax({type:"GET",url:t.endpoint||getEnv().sparql_endpoint,dataType:"jsonp",accepts:{json:"application/javascript"},jsonpCallback:"receive"+t.name,data:{query:e,output:"json",app_name:getEnv().app_name},success:parser(t)})},Prefix=function(t,e){this.name=t,this.uri=e};Prefix.prototype.match=function(t){return t.startsWith(this.uri)},Prefix.prototype.toShortForm=function(t){return this.name+":"+t.substring(this.uri.length)};var prefixArray=[new Prefix("ic","http://imi.go.jp/ns/core/rdf#"),new Prefix("odp","http://odp.jig.jp/odp/1.0#"),new Prefix("rdfs","http://www.w3.org/2000/01/rdf-schema#"),new Prefix("rdf","http://www.w3.org/1999/02/22-rdf-syntax-ns#"),new Prefix("schema","http://schema.org/"),new Prefix("dct","http://purl.org/dc/terms/"),new Prefix("geo","http://www.w3.org/2003/01/geo/wgs84_pos#"),new Prefix("dsv","http://datashelf.jp/ns/dsv#"),new Prefix("kobe","http://data.city.kobe.lg.jp/ns/kobetoday#")],toShortForm=function(t){for(var e=0;e<prefixArray.length;e++){var i=prefixArray[e];if(i.match(t))return i.toShortForm(t)}return"<"+t+">"},initSpinner=function(){$("#spinner_overlay").click(function(t){t.stopPropagation()})},stopSpinner=function(){$("#spinner_overlay").fadeOut()},SpotCategory=function(t,e){this.key=t,this.text=e},Spot=function(t){this.uri=t.uri,this.position=new GeoPosition(parseFloat(t.lat),parseFloat(t.lng)),this.type=t.type2||t.type1,this.genre=t.genre1,this.category=getCategory(this.type,this.genre)},lastOpenInfoWindow;Spot.prototype.getMarker=function(t){if(this.marker?this.marker.setTitle(this.title):this.marker=new google.maps.Marker({position:this.position.getLatLng(),title:this.title,icon:getPinIcon(this.category.key)}),t){var e=new google.maps.InfoWindow({content:this.getInfoContent(),maxWidth:300});e.setPosition(this.position.getLatLng()),this.markerClickListener&&marker.removeListener(this.markerClickListener),this.markerClickListener=this.marker.addListener("click",function(){lastOpenInfoWindow&&lastOpenInfoWindow.close(),e!==lastOpenInfoWindow?(e.open(t,this),lastOpenInfoWindow=e):lastOpenInfoWindow=void 0})}return this.marker},Spot.prototype.getInfoContent=function(){var t='<div id="info"><dl>';return this.title&&(t+="<dt>タイトル</dt><dd>"+this.title+"</dd>"),t+="<dt>分類</dt><dd>"+this.category.text+"</dd>",this.genre&&(t+="<dt>種別</dt><dd>"+this.genre+"</dd>"),t+"<dt>地理座標</dt><dd>"+this.position.text+'</dd></dl><div style="text-align:right;"><a href="#" onclick="showDetail(this);return false;" data-spoturi="'+encodeURIComponent(this.uri)+'">詳細はこちら</a></div></div>'};var categories={event:new SpotCategory("event","イベント"),hazard:new SpotCategory("hazard","防災"),tourspot:new SpotCategory("tourspot","観光"),facility:new SpotCategory("facility","施設"),other:new SpotCategory("other","その他")},typeMap={"http://purl.org/jrrk#CivicEvent":"event","http://purl.org/jrrk#CivicPOI":"tourspot","http://purl.org/jrrk#CulturalProperty":"tourspot","http://purl.org/jrrk#EmergencyFacility":"hazard","http://purl.org/jrrk#TemporaryGatheringLocation":"hazard","http://purl.org/jrrk#RequiringAssistanceAuthorizedUsersFacilityDisaster":"hazard","http://purl.org/jrrk#CivicFacility":"facility","http://purl.org/jrrk#MedicalInstitute":"facility","http://purl.org/jrrk#ParkingFacility":"facility","http://purl.org/jrrk#Polls":"facility","http://purl.org/jrrk#PosterPlace":"facility","http://purl.org/jrrk#BusStop":"facility","http://purl.org/jrrk#FarmersMarket":"facility","http://odp.jig.jp/odp/1.0#TourSpot":"tourspot","http://odp.jig.jp/odp/1.0#Polls":"facility","http://odp.jig.jp/odp/1.0#PosterPlace":"facility","http://imi.go.jp/ns/core/rdf#施設型":"facility","http://imi.go.jp/ns/core/rdf#イベント型":"event","http://datashelf.jp/ns/dsv#観光スポット型":"tourspot","http://datashelf.jp/ns/dsv#観光スポット":"tourspot","http://datashelf.jp/ns/dsv#応急給水拠点":"hazard",last:!1},getCategory=function(t){var e=typeMap[t];return e||unknownType[t]||(unknownType[t]=!0),categories[e]},unknownType={},RequestSpot=function(t){this.name="Spot",this.offset=0,this.limit=1e4,this.executed=!1,this.spots={},this.callback=t||function(){console.log("spot data has loaded.")}};RequestSpot.prototype.query=function(){return"PREFIX ic: <http://imi.go.jp/ns/core/rdf#> PREFIX odp: <http://odp.jig.jp/odp/1.0#> PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#> PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> SELECT ?s1 ?type1 ?s2 ?type2 ?genre1 ?lat ?lng { ?s1 ic:地理座標 [ ic:緯度 ?lat ; ic:経度 ?lng ] ; a ?type1 . OPTIONAL { { ?s1 ic:種別 ?genre1 } UNION { ?s1 odp:genre/rdf:_1/odp:genre* [ a odp:LargeGenre ; rdfs:label ?genre1 ] } } . OPTIONAL { ?s2 ?p1 ?s1 ; a ?type2 } FILTER ( !BOUND(?p1) || ?p1 != <http://www.w3.org/2002/07/owl#sameAs> ) } ORDER BY ?s1 ?s2 OFFSET "+this.offset+" LIMIT "+this.limit},RequestSpot.prototype.parse=function(t){for(var e=0;e<t.length;e++){var i=t[e];i.uri=i.s2||i.s1;var o=new Spot(i);this.spots.hasOwnProperty(o.uri)||(this.spots[o.uri]=o)}if(getEnv().debug||t.length!==this.limit){var r=this,n=new RequestSpotTitle(this.spots,function(){r.callback(r.spots)});executeSparql(n)}else this.offset+=this.limit,executeSparql(this)};var RequestSpotTitle=function(t,e){this.name="SpotTitle",this.offset=0,this.limit=1e4,this.spots=t,this.executed=!1,this.callback=e||function(){console.log("spot title has loaded.")}};RequestSpotTitle.prototype.getRange=function(){var t=null,e=null;for(var i in this.spots)(!t||i<t)&&(t=i),(!e||e<i)&&(e=i);return{first:t,last:e}},RequestSpotTitle.prototype.query=function(){var t="",e=this.getRange();return e.first&&e.last&&(t=' && str(?s)>"'+e.first+'" && str(?s)<"'+e.last+'" '),"PREFIX ic: <http://imi.go.jp/ns/core/rdf#> PREFIX odp: <http://odp.jig.jp/odp/1.0#> PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#> PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> SELECT ?s ?title { ?s ic:名称/ic:表記 ?title . FILTER (!isBlank(?s)"+t+' && lang(?title) in ("ja", "")) } ORDER BY ?s OFFSET '+this.offset+" LIMIT "+this.limit},RequestSpotTitle.prototype.parse=function(t){for(var e=0;e<t.length;e++){var i=t[e],o=this.spots[i.s];o&&(o.title=i.title)}t.length==this.limit?(this.offset+=this.limit,executeSparql(this)):this.callback()};var RequestSpotDetail=function(t,e){this.name="SpotDetail",this.offset=0,this.limit=1e4,this.uri=t,this.executed=!1,this.callback=e||function(t){console.log("spot detail has loaded.",t)},this.result={}};RequestSpotDetail.prototype.query=function(){return"PREFIX ic: <http://imi.go.jp/ns/core/rdf#> PREFIX odp: <http://odp.jig.jp/odp/1.0#> PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#> PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> SELECT ?p1 ?o1 ?p2 ?o2 ?p3 ?o3 { <"+this.uri+"> ?p1 ?o1 . OPTIONAL { ?o1 ?p2 ?o2 . OPTIONAL { ?o2 ?p3 ?o3 } } } ORDER BY ?p1 ?o1 ?p2 ?o2 ?p3 ?o3 OFFSET "+this.offset+" LIMIT "+this.limit},RequestSpotDetail.prototype.parse=function(t){for(var e=0;e<t.length;e++){var i=this.getPropertyAndObject(t[e]);if(this.result[i.property])if($.isArray(this.result[i.property]))this.result[i.property].push(i.object);else{var o=[];o.push(this.result[i.property]),o.push(i.object),this.result[i.property]=o}else this.result[i.property]=i.object}t.length==this.limit?(this.offset+=this.limit,executeSparql(this)):this.callback(new SpotDetail(this.result))},RequestSpotDetail.prototype.parseLiteral=function(t){var e=t["xml:lang"];return e&&e.length>0?{value:t.value,lang:e}:t.value},RequestSpotDetail.prototype.getPropertyAndObject=function(t){for(var e=toShortForm(t.p1),i=t.o1,o=2;o<=3;o++){var r="p"+o;if(!t[r])break;e+="/"+toShortForm(t[r]),i=t["o"+o]}return{property:e,object:i}};var SpotDetail=function(t){this.data=t,this.title=t["ic:名称/ic:表記"]||t["rdfs:label"],this.category=getCategory(t["rdf:type"]),this.description=t["ic:説明"]||t["schema:description"],this.note=t["kobe:ScheduleNotice"];var e=t["ic:Webサイト"]||t["schema:url"];e&&!e.startsWith("http")&&(e=null),this.url=e,this.address=t["ic:住所/ic:表記"]||t["ic:開催場所/ic:住所/ic:表記"],this.place=t["ic:開催場所/ic:名称/ic:表記"],this.price=t["ic:料金/ic:表記"],this.genre=normalizeLiteral(t["ic:種別"],"ja"," / "),this.image=t["ic:画像"]||t["schema:image"],this.contact=t["ic:連絡先/ic:名称/ic:表記"];var i=t["ic:連絡先/ic:電話番号"];i&&i.length>6&&(this.phone=i),this.latitude=t["ic:地理座標/ic:緯度"]||t["ic:開催場所/ic:地理座標/ic:緯度"]||t["geo:lat"],this.longitude=t["ic:地理座標/ic:経度"]||t["ic:開催場所/ic:地理座標/ic:経度"]||t["geo:long"]};SpotDetail.prototype.getPosition=function(){return this.latitude&&this.longitude?new GeoPosition(this.latitude,this.longitude):null},SpotDetail.prototype.getCategory=function(){return this.type?getCategory(this.type):null};var normalizeLiteral=function(t,e,i){if(t){if($.isArray(t)){for(var o=[],r=0;r<t.length;r++){var n=t[r];n.lang?n.lang===e&&o.push(n.value):o.push(n)}return i=i||" / ",o.join(i)}if(t.lang)return t.lang===e?t.value:""}else;return t};Array.prototype.contains=function(t){for(var e=0;e<this.length;e++)if(this[e]===t)return!0;return!1};var join=function(t,e){return $.isArray(t)?t.join(e):t};